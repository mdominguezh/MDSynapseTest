# This is a basic workflow to help you get started with Actions

name: Copy between Table storage 

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  #push:
  #  branches: [ "workspace_publish" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs: 
  testjob:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Install azcopyv7 to copy table storage
        shell: pwsh
        run: |
          $client = new-object System.Net.WebClient
          $client.DownloadFile("https://aka.ms/downloadazcopynet","C:\Windows\Temp\MicrosoftAzureStorageAzCopy.msi")
          Start-Process msiexec.exe -Wait -ArgumentList '/I C:\Windows\Temp\MicrosoftAzureStorageAzCopy.msi /quiet /L*v "C:\Windows\Temp\AzCopy-Install.log"'
          #type "C:\Windows\Temp\AzCopy-Install.log"
          #Get-Command azcopy
          #Get-Command azcopyv7
          #Get-ChildItem -Path C:\Windows\System32
          #Get-ChildItem -Path "C:\Program Files"
          mkdir tableexport
          #azcopy copy --help
          #Start-Process -FilePath "C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy\AzCopy.exe" -ArgumentList "/help" -NoNewWindow
          Start-Process -FilePath "C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy\AzCopy.exe" -ArgumentList "/Source:https://mddlakestorage.table.core.windows.net/MDTestTable1","/Dest:D:\a\MDSynapseTest\MDSynapseTest\tableexport\","/SourceKey:${{secrets.SOURCE_STORAGE_KEY}}" -NoNewWindow
          Start-Sleep -s 20
          Write-Output "Detro de tableexport:"
          Get-ChildItem -Path D:\a\MDSynapseTest\MDSynapseTest\tableexport
          Start-Sleep -s 5
          Write-Output "Listado directorio actual:"
          Get-ChildItem -Path .
          Start-Sleep -s 5
          Write-Output "Directorio actual:"
          cd
          Start-Sleep -s 5
          Write-Output "Mostramos el manifiesto"
          $prueba=Get-ChildItem -Path D:\a\MDSynapseTest\MDSynapseTest\tableexport -Filter *.manifest -Recurse | %{$_.FullName}
          type $prueba
          Write-Output "Mostramos el JSON"
          $prueba2=Get-ChildItem -Path D:\a\MDSynapseTest\MDSynapseTest\tableexport -Filter *.json -Recurse | %{$_.FullName}
          type $prueba2
          Write-Output "Mostramos el MD5"
          Get-FileHash $prueba2 -Algorithm MD5 | Format-List
          #type mddlakestorage_MDTestTable1_*.manifest
          Start-Sleep -s 5
          Write-Output "Retauramos en PRO"
          $manifestfilename=(Get-Item $prueba ).Name 
          Start-Process -FilePath "C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy\AzCopy.exe" -ArgumentList "/Source:D:\a\MDSynapseTest\MDSynapseTest\tableexport\","/Dest:https://mddlakestoragepro.table.core.windows.net/MDTestTable1","/DestKey:${{secrets.DESTINATION_STORAGE_KEY}}","/Manifest:$manifestfilename","/V:D:\a\MDSynapseTest\MDSynapseTest\tableexport\import-verbose-log-file.log","/EntityOperation:InsertOrReplace" -NoNewWindow
          Start-Process -FilePath "C:\Program Files (x86)\Microsoft SDKs\Azure\AzCopy\AzCopy.exe" -ArgumentList "/?" -NoNewWindow
          Start-Sleep -s 25
          Write-Output "Mostramos el log del import"
          type D:\a\MDSynapseTest\MDSynapseTest\tableexport\import-verbose-log-file.log
  buildjob:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - name: Install azcopyv7 to copy table storage
        run: tar -xzf ./utils/azcopy_7.3.0-netcore_linux_x64_modified.tar.gz; sudo ./azcopy_7.3.0-netcore_linux_x64/install.sh
      - name: Copy between table storage
        run: |
          mkdir tableexport
          count=$(jq '.table | length' ./mdsynapsewspace/datamigration.json)
          echo ${count}
          for ((i=0; i<$count; i++)); do
            src=$(jq -r '.table['$i'].source' ./mdsynapsewspace/datamigration.json)
            echo ${src}
            dst=$(jq -r '.table['$i'].destination' ./mdsynapsewspace/datamigration.json)
            echo ${dst}
            #azcopyv7 --source ${src} --destination ~/tableexport/ --source-key ${{secrets.SOURCE_STORAGE_KEY}} --verbose
            azcopyv7 --help
            azcopyv7 /Source:${src} /Dest:~/tableexport/ /SourceKey:${{secrets.SOURCE_STORAGE_KEY}}
          done
      - run: ls -lhA ./tableexport/
      # Azure logout
      - name: logout
        run: |
          az logout
        if: always()
